<div class="h-full flex flex-col">
  <div class="flex-1 overflow-y-auto p-4">
    <div class="space-y-4">
      <div *ngFor="let message of messages; trackBy: trackByMessageId"
           [class.items-end]="isMyMessage(message.senderId)"
           [class.items-start]="!isMyMessage(message.senderId)"
           class="flex flex-col">
        <div *ngIf="!isMyMessage(message.senderId)" class="text-sm text-gray-500 mb-1">
          {{ message.senderName }}
        </div>
        <div [class.bg-blue-500]="isMyMessage(message.senderId)"
             [class.bg-gray-200]="!isMyMessage(message.senderId)"
             [class.text-white]="isMyMessage(message.senderId)"
             class="rounded-lg p-3 max-w-xs lg:max-w-md">
          <div *ngIf="message.messageType === 'TEXT'">{{ message.content }}</div>

          <!-- Enhanced attachment preview -->
          <div *ngFor="let attachment of message.attachments" class="mt-2">
            <!-- Image attachment -->
            <div *ngIf="attachment.fileType.startsWith('image/')" class="rounded-lg overflow-hidden">
              <img [src]="(getSafeFileUrl(attachment.fileUrl))"
                   class="max-w-full max-h-64 object-cover cursor-pointer"
                   (click)="openMediaViewer(attachment)">
              <div class="text-xs mt-1 truncate"
                   [class.text-blue-100]="isMyMessage(message.senderId)"
                   [class.text-gray-700]="!isMyMessage(message.senderId)">
                {{ attachment.fileUrl | filenameFromUrl }}
              </div>
            </div>

            <!-- Video attachment -->
            <div *ngIf="attachment.fileType.startsWith('video/')" class="rounded-lg overflow-hidden">
              <video controls class="max-w-full max-h-64">
                <source [src]="attachment.fileUrl" [type]="attachment.fileType">
                Your browser does not support the video tag.
              </video>
              <div class="text-xs mt-1 truncate"
                   [class.text-blue-100]="isMyMessage(message.senderId)"
                   [class.text-gray-700]="!isMyMessage(message.senderId)">
                {{ attachment.fileUrl | filenameFromUrl }}
              </div>
            </div>

            <!-- Audio attachment -->
            <div *ngIf="attachment.fileType.startsWith('audio/')"
                 class="flex items-center gap-2 p-2 rounded-lg bg-black bg-opacity-10">
              <button (click)="toggleAudioPlayback(attachment)" class="text-lg">
                {{ isAudioPlaying(attachment) ? '⏸️' : '▶️' }}
              </button>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate">{{ attachment.fileUrl | filenameFromUrl }}</div>
                <div *ngIf="attachment.fileSizeBytes" class="text-xs opacity-75">
                  {{ formatFileSize(attachment.fileSizeBytes) }}
                </div>
              </div>
              <audio #audioPlayer [src]="attachment.fileUrl" (ended)="onAudioEnded(attachment)"></audio>
            </div>

            <!-- Document attachment -->
            <div *ngIf="!attachment.fileType.startsWith('image/') &&
                        !attachment.fileType.startsWith('video/') &&
                        !attachment.fileType.startsWith('audio/')"
                 class="flex items-center gap-2 p-2 rounded-lg border"
                 [class.border-blue-200]="isMyMessage(message.senderId)"
                 [class.border-gray-300]="!isMyMessage(message.senderId)">
              <div class="text-2xl text-gray-500">
                {{ getFileIcon(attachment) }}
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate">{{ attachment.fileUrl | filenameFromUrl }}</div>
                <div *ngIf="attachment.fileSizeBytes" class="text-xs text-gray-500">
                  {{ formatFileSize(attachment.fileSizeBytes) }}
                </div>
              </div>
              <a [href]="attachment.fileUrl"
                 [download]="attachment.fileUrl | filenameFromUrl"
                 class="text-blue-500 hover:text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </a>
            </div>
          </div>

          <div class="text-xs mt-1 text-right"
               [class.text-blue-100]="isMyMessage(message.senderId)"
               [class.text-gray-500]="!isMyMessage(message.senderId)">
            {{ message.sentAt | date:'shortTime' }}
            <span *ngIf="isMyMessage(message.senderId)" class="ml-1">
              <!-- Status icons remain the same -->
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
