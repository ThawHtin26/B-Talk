<div class="h-full flex flex-col">
  <!-- Loading more indicator at top -->
  <div *ngIf="getIsLoadingMore()" class="flex items-center justify-center p-2">
    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading && !getIsLoadingMore()" class="flex-1 flex items-center justify-center">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>

  <!-- Error state -->
  <div *ngIf="error" class="flex-1 flex items-center justify-center p-4">
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
      <span class="block sm:inline">{{ error }}</span>
      <button (click)="retryLoadMessages()" class="mt-2 text-sm bg-red-500 hover:bg-red-700 text-white py-1 px-2 rounded">
        Retry
      </button>
    </div>
  </div>

  <!-- Message list with scroll event -->
  <div class="flex-1 overflow-y-auto p-4" #messageContainer (scroll)="onScroll()">
    <div class="space-y-4">
      <div *ngFor="let message of messages; trackBy: trackByMessageId"
           [class.items-end]="isMyMessage(message.senderId)"
           [class.items-start]="!isMyMessage(message.senderId)"
           class="flex flex-col">

        <!-- Sender name for received messages -->
        <div *ngIf="!isMyMessage(message.senderId)" class="flex items-center gap-2 text-sm text-gray-500 mb-1">
          <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-300 text-gray-600">
            <span class="text-xs">{{ message.senderName | slice:0:1 | uppercase }}</span>
          </span>
          <span>{{ message.senderName }}</span>
        </div>

        <!-- Message bubble -->
        <div [class.bg-blue-600]="isMyMessage(message.senderId)"
             [class.bg-gray-100]="!isMyMessage(message.senderId)"
             [class.text-white]="isMyMessage(message.senderId)"
             [class.text-gray-800]="!isMyMessage(message.senderId)"
             class="rounded-2xl p-3 max-w-xs lg:max-w-md shadow-sm relative"
             [class.rounded-tr-none]="isMyMessage(message.senderId)"
             [class.rounded-tl-none]="!isMyMessage(message.senderId)">

          <!-- Text message content -->
          <div *ngIf="message.messageType === 'TEXT'" class="whitespace-pre-wrap"> {{ message.content | lineBreak:30 }}</div>

          <!-- Enhanced attachment preview -->
          <div *ngFor="let attachment of message.attachments" class="mt-2">
            <!-- Image attachment -->
            <div *ngIf="attachment.fileType.startsWith('image/')" class="rounded-lg overflow-hidden">
              <img [src]="(getSafeFileUrl(attachment.fileUrl))"
                   class="max-w-full max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity"
                   (click)="openMediaViewer(attachment)">
              <div class="text-xs mt-1 truncate flex items-center gap-1"
                   [class.text-blue-100]="isMyMessage(message.senderId)"
                   [class.text-gray-700]="!isMyMessage(message.senderId)">
                <mat-icon class="material-icons-outlined text-base">image</mat-icon>
                {{ attachment.fileUrl | filenameFromUrl }}
              </div>
            </div>

            <!-- Video attachment -->
            <div *ngIf="attachment.fileType.startsWith('video/')" class="rounded-lg overflow-hidden">
              <video controls class="max-w-full max-h-64" preload="metadata">
                <source [src]="attachment.fileUrl" [type]="attachment.fileType">
                Your browser does not support the video tag.
              </video>
              <div class="text-xs mt-1 truncate flex items-center gap-1"
                   [class.text-blue-100]="isMyMessage(message.senderId)"
                   [class.text-gray-700]="!isMyMessage(message.senderId)">
                <mat-icon class="material-icons-outlined text-base">videocam</mat-icon>
                {{ attachment.fileUrl | filenameFromUrl }}
              </div>
            </div>

            <!-- Audio attachment -->
            <div *ngIf="attachment.fileType.startsWith('audio/')"
                 class="flex items-center gap-3 p-3 rounded-lg"
                 [class.bg-blue-700]="isMyMessage(message.senderId)"
                 [class.bg-gray-200]="!isMyMessage(message.senderId)">
              <button (click)="toggleAudioPlayback(attachment)"
                      class="flex items-center justify-center h-10 w-10 rounded-full"
                      [class.bg-blue-800]="isMyMessage(message.senderId)"
                      [class.bg-gray-300]="!isMyMessage(message.senderId)">
                <mat-icon class="material-icons-outlined text-lg">
                  {{ isAudioPlaying(attachment) ? 'pause' : 'play_arrow' }}
                </mat-icon>
              </button>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate flex items-center gap-1">
                  <mat-icon class="material-icons-outlined text-base">audiotrack</mat-icon>
                  {{ attachment.fileUrl | filenameFromUrl }}
                </div>
                <div *ngIf="attachment.fileSizeBytes" class="text-xs opacity-75">
                  {{ formatFileSize(attachment.fileSizeBytes) }}
                </div>
              </div>
              <audio #audioPlayer [src]="attachment.fileUrl" (ended)="onAudioEnded(attachment)"></audio>
            </div>

            <!-- Document attachment -->
            <div *ngIf="!attachment.fileType.startsWith('image/') &&
                        !attachment.fileType.startsWith('video/') &&
                        !attachment.fileType.startsWith('audio/')"
                 class="flex items-center gap-3 p-3 rounded-lg"
                 [class.bg-blue-700]="isMyMessage(message.senderId)"
                 [class.bg-gray-100]="!isMyMessage(message.senderId)"
                 [class.border]="!isMyMessage(message.senderId)"
                 [class.border-gray-200]="!isMyMessage(message.senderId)">
              <div class="text-3xl"
                   [class.text-blue-200]="isMyMessage(message.senderId)"
                   [class.text-gray-500]="!isMyMessage(message.senderId)">
                <mat-icon class="material-icons-outlined">{{ getFileIcon(attachment) }}</mat-icon>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm truncate">{{ attachment.fileUrl | filenameFromUrl }}</div>
                <div *ngIf="attachment.fileSizeBytes" class="text-xs"
                     [class.text-blue-200]="isMyMessage(message.senderId)"
                     [class.text-gray-500]="!isMyMessage(message.senderId)">
                  {{ formatFileSize(attachment.fileSizeBytes) }}
                </div>
              </div>
              <a [href]="attachment.fileUrl"
                 [download]="attachment.fileUrl | filenameFromUrl"
                 class="text-blue-400 hover:text-blue-300">
                <mat-icon class="material-icons-outlined">download</mat-icon>
              </a>
            </div>
          </div>

          <!-- Message timestamp and status -->
          <div class="text-xs mt-1 flex items-center justify-end gap-1"
               [class.text-blue-200]="isMyMessage(message.senderId)"
               [class.text-gray-500]="!isMyMessage(message.senderId)">
            <span>{{ message.sentAt | date:'shortTime' }}</span>
            <span *ngIf="isMyMessage(message.senderId)">
              <mat-icon *ngIf="message.status === 'SENT'" class="material-icons-outlined text-sm">done</mat-icon>
              <mat-icon *ngIf="message.status === 'DELIVERED'" class="material-icons-outlined text-sm">done_all</mat-icon>
              <mat-icon *ngIf="message.status === 'SEEN'" class="material-icons-outlined text-sm text-blue-300">done_all</mat-icon>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
